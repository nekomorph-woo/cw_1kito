# 规划审查报告

**审查日期:** 2025-02-10
**审查人:** Claude Code Reviewer
**文档版本:**
- 10_Module_Design.md v1.0
- 11_Task_List.md v1.0

---

## 1. 总体评价

- **评分:** 7.5/10
- **摘要:** 模块设计和任务列表文档整体结构完整，技术方案合理。防腐层设计优秀，TDD 测试用例覆盖良好。但存在一些关键功能遗漏和潜在风险点需要补充，特别是 API 响应格式容错、多屏幕适配和错误恢复机制。

---

## 2. 优点

1. **防腐层设计优秀** - 通过 TranslationApiAdapter 接口有效隔离外部 API 结构变化，内部领域模型保持独立
2. **TDD 测试覆盖充分** - 每个核心模块都提供了具体的测试用例，包括边界条件和异常场景
3. **任务依赖关系清晰** - 使用 Mermaid 图直观展示任务间的依赖关系，便于排期和并行开发
4. **坐标验证机制详细** - CoordinateValidator 设计了边界裁剪、最小尺寸扩展、重叠处理等容错策略
5. **文档结构完整** - 从数据层到 UI 层的分层架构清晰，每个模块职责明确

---

## 3. 遗漏点

### 3.1 API 响应格式容错
**描述:** 防腐层未处理 API 返回可能包含 Markdown 代码块的情况
**影响:** 当 LLM 返回 `\`\`\`json\n[{...}]\n\`\`\`` 格式时，JSON 解析会失败
**建议:** 在 `SiliconFlowAdapter.toInternalResponse()` 中添加预处理逻辑：
```kotlin
private fun cleanMarkdownWrap(content: String): String {
    return content.removePrefix("```json")
        .removePrefix("```")
        .removeSuffix("```")
        .trim()
}
```
**关联任务:** T-006

### 3.2 网络请求缓存机制
**描述:** 缺少简单的响应缓存，可能导致短时间内重复请求浪费额度
**影响:** 用户误触或网络波动时重复请求，增加 API 调用成本
**建议:** 添加 T-021 任务：实现基于图像哈希的简单缓存（5分钟 TTL）
**优先级:** P1

### 3.3 多屏幕适配
**描述:** 未考虑折叠屏、多窗口模式、屏幕旋转的场景
**影响:** 在新设备形态上可能显示异常
**建议:**
- 在 OverlayView 中添加屏幕方向变化监听
- 测试折叠屏的多屏显示场景
- 添加屏幕尺寸变化时的坐标重新计算
**关联任务:** T-013, T-018

### 3.4 首次使用引导流程
**描述:** 缺少首次启动的用户引导教程
**影响:** 用户可能不清楚如何配置 API Key 和授予权限
**建议:** 添加 T-102 任务（注意与现有 T-102 冲突，建议重命名为 T-103 或调整编号）：实现首次启动引导界面
**优先级:** P1

### 3.5 网络状态监听
**描述:** 缺少网络断开/重连的监听和处理
**影响:** 网络波动时用户体验差，无明确提示
**建议:** 在 T-014 PermissionManager 中扩展或独立创建 NetworkMonitor 模块
**关联任务:** T-014, T-019

### 3.6 日志和崩溃监控
**描述:** 未规划生产环境的问题追踪方案
**影响:** 发布后难以定位用户问题
**建议:**
- 集成 Timber 进行结构化日志
- 集成 Firebase Crashlytics 或 Sentry
- 添加用户反馈渠道
**优先级:** P2

### 3.7 图片预处理优化
**描述:** 截图后直接上传全屏图片，效率不高
**影响:** API 调用成本高，响应慢
**建议:** 添加 T-104 任务：实现智能裁剪（可选区域截图、边缘检测）
**优先级:** P2

---

## 4. 风险点

### 4.1 坐标验证参数适配性
**风险:** 不同设备的屏幕密度和尺寸差异大，固定的 `minBoxSize = 0.02f` 可能不适配所有设备
**缓解建议:**
- 根据屏幕密度动态调整参数
- 提供高级设置允许用户调整
- 收集实际使用数据进行优化

### 4.2 内存泄漏风险
**风险:** 处理大量翻译结果时可能导致 OOM
**缓解建议:**
- 限制单次翻译结果数量上限（如 50 个）
- 及时释放 Bitmap 和大型对象
- 使用 LeakCanary 进行内存泄漏检测

### 4.3 MediaProjection 权限体验
**风险:** 每次启动服务需要用户确认录屏权限
**缓解建议:**
- 添加权限状态持久化
- 在文档中说明系统限制
- 考虑使用 Accessibility API 作为备选方案（需单独评估）

### 4.4 API 响应超时处理
**风险:** 网络慢或 API 响应慢时用户可能认为应用卡死
**缓解建议:**
- 添加明确的加载进度提示
- 实现超时重试机制
- 提供取消按钮

### 4.5 厂商 ROM 兼容性
**风险:** 小米、华为等厂商对悬浮窗权限有额外限制
**缓解建议:**
- 在主流厂商设备上进行测试
- 添加厂商特定的引导文案
- 建立兼容性问题清单

---

## 5. 优化建议

### 5.1 防腐层增强
**具体改进:**
```kotlin
// 在 SiliconFlowAdapter 中添加
private fun extractJsonFromContent(content: String): String {
    // 1. 尝试直接解析
    // 2. 失败则尝试移除 Markdown 包裹
    // 3. 失败则尝试正则提取 JSON 数组
}
```

### 5.2 坐标验证参数动态化
**具体改进:**
```kotlin
data class CoordinateValidatorConfig(
    val minBoxSizeDp: Float = 10f,      // 改为 dp 单位
    val expansionPaddingDp: Float = 5f,
    val overlapThreshold: Float = 0.5f
)
```

### 5.3 添加缓存机制任务
```markdown
#### T-021: 实现翻译结果缓存
**优先级:** P1
**预计时间:** 3 小时
**描述:** 基于图像哈希的简单缓存，避免短时间内重复请求
**交付物:**
- CacheManager 接口和实现
- 图像哈希计算工具
```

### 5.4 修正验收标准
**问题:** 任务列表中验收标准的复选框显示为已完成 `[x]`
**修正:** 全部改为未完成状态 `[ ]`

### 5.5 添加错误恢复任务
```markdown
#### T-022: 实现请求队列和重试机制
**优先级:** P1
**预计时间:** 4 小时
**描述:** 网络断开时缓存请求，恢复后自动重试
```

---

## 6. TDD 检查

### 6.1 测试覆盖率目标合理性
| 模块 | 目标 | 评价 |
|------|------|------|
| 领域模型 | 90% | 合理 |
| 数据层 | 85% | 合理 |
| 领域层 | 80% | 合理 |
| Service 层 | 70% | 偏低，建议提升到 75% |
| UI 层 | 60% | 合理 |

### 6.2 测试场景覆盖
- **已覆盖:** 坐标归一化、边界裁剪、JSON 序列化、权限检查
- **建议添加:**
  - API 返回异常格式的测试（如 Markdown 包裹）
  - 内存压力测试（大量翻译结果）
  - 网络超时重试测试

---

## 7. 审查结论

- [x] **通过** - 规划整体可行，可以进入执行阶段
- [ ] **需要修改** - 列出必须修改的项

### 必须修改项（执行前处理）
1. 将任务验收标准的复选框从 `[x]` 改为 `[ ]`
2. 在 T-006 防腐层中添加 Markdown 代码块解析处理
3. 添加 T-021 缓存机制任务（优先级 P1）

### 建议优化项（执行中处理）
1. 添加网络状态监听模块
2. 添加首次使用引导流程
3. 实现崩溃报告集成
4. 进行多屏幕适配测试

---

## 8. 后续行动

### 立即行动
1. 项目负责人确认必须修改项
2. 更新 11_Task_List.md 中的验收标准
3. 补充 T-021 缓存任务到任务列表

### 第一周执行
1. 完成 T-001 到 T-003（基础设施）
2. 同时进行设备兼容性调研

### 第二周执行
1. 重点完成防腐层和 API 客户端
2. 进行 API 响应格式容错测试

---

**审查完成。建议在执行前处理必须修改项，然后可进入开发阶段。**
