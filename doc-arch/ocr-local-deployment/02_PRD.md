# 产品需求文档 (PRD): 本地优先 OCR 翻译系统

**文档版本:** 1.1
**最后更新:** 2026-02-13
**状态:** DRAFT

---

## 1. 产品愿景

### 1.1 愿景声明

构建一个完全本地化的 Android 屏幕翻译应用,通过专用 OCR 模型和轻量级翻译引擎,实现离线、低延迟、零成本的跨语言屏幕内容理解,为游戏玩家、漫画读者和多语言用户提供实时翻译体验。

**长期愿景:** 成为 Android 平台上最快、最隐私的屏幕翻译工具,支持 50+ 语言互译,用户无需网络即可翻译任何屏幕内容,并通过智能文本合并和自适应排版保持原文可读性。

### 1.2 价值主张

#### 速度与性能
- **本地优先架构:** OCR + 翻译全程在设备完成,延迟从云端方案的 5-7 秒降至 0.5-1 秒
- **旗舰机优化:** 在 OnePlus 15 等 Snapdragon 8 Elite 设备上,Google ML Kit OCR 推理 <200ms,Google ML Kit 翻译 <100ms
- **渐进式适配:** 中端设备通过图片降级和设备适配保持可用

#### 隐私与成本
- **零网络依赖:** 截图数据不上传服务器,完全本地处理
- **零边际成本:** 无 API 调用费用,开发者无持续云服务成本,用户无流量消耗
- **离线可用:** 飞行模式、海外漫游、无网络环境均可使用

#### 智能文本处理
- **自适应合并算法:** Y 轴聚类识别行 + X 轴合并同行文本 + 横竖排自动检测
- **保持原文排版:** 翻译后文本保持段落结构,避免支离破碎
- **复杂布局支持:** 游戏对话框、漫画气泡、菜单列表均可正确识别和翻译

#### 灵活性与可控性
- **混合模式:** 本地极速模式 + 云端高质量备选,用户根据场景切换
- **参数可调:** 合并阈值、图片分辨率、性能模式均可配置
- **语言包管理:** 按需下载中英日韩等语言包,支持卸载节省空间

---

## 2. 问题陈述

### 2.1 当前状态

**现有解决方案的问题:**

1. **云端 VL 模型速度慢**
   - 使用 Qwen2.5-VL-32B-Instruct 等视觉大模型进行 OCR+坐标+翻译
   - 单次请求耗时 2-5 秒,用户等待时间长
   - 图像编码器 (ViT) 计算量大,token 消耗多
   - 受网络质量影响,移动网络下延迟更明显

2. **网络依赖性强**
   - 依赖硅基流动等云服务 API
   - 无网络时完全不可用
   - 数据上传到服务器,用户隐私担忧
   - 高频用户 API 调用成本累积 ($10-50/月)

3. **文本框拆分严重**
   - OCR 输出将同行文字拆成多个小框 (字/词级别)
   - 翻译后文本支离破碎,无法阅读
   - 游戏界面、漫画对话框场景尤甚

4. **横竖混合布局处理混乱**
   - 日文漫画/游戏常混排横竖文本
   - 简单 Y 轴聚类会误合并不同方向的文本
   - 翻译结果错乱,用户无法理解

### 2.2 痛点

#### [P1] 等待时间过长 (影响体验)
- **谁经历:** 所有需要实时翻译的用户
- **何时发生:** 每次截图翻译时
- **影响:**
  - 游戏对话翻译错过重要剧情
  - 漫画阅读频繁中断
  - 用户流失到竞品

#### [P2] 网络不稳定时不可用 (影响可靠性)
- **谁经历:** 地铁用户、海外旅行者、弱信号区域用户
- **何时发生:** 网络质量差或无网络时
- **影响:** 完全无法使用核心功能,用户挫败感强

#### [P3] 翻译结果可读性差 (影响实用性)
- **谁经历:** 翻译游戏/漫画内容的用户
- **何时发生:** OCR 将同行文字拆分时
- **影响:** 用户需要手动拼凑碎片,翻译价值大打折扣

#### [P4] 横竖文本误合并 (影响准确性)
- **谁经历:** 翻译日文漫画、游戏 UI 的用户
- **何时发生:** 同一画面存在横排和竖排文本时
- **影响:** 翻译结果逻辑错误,用户困惑

#### [P5] 云端 API 成本高 (影响可持续性)
- **谁经历:** 高频使用者和开发者
- **何时发生:** 每次 API 调用
- **影响:**
  - 用户: 长期使用成本高昂
  - 开发者: 云服务账单压力大,盈利模式受限

### 2.3 影响

**不解决此问题的影响:**
- **用户体验:** 持续等待,无法实现真正的 "实时" 翻译
- **市场份额:** 竞品 (如 Google Lens) 已支持离线,本地方案竞争力不足
- **商业模式:** 云端 API 成本随用户增长线性增加,难以规模盈利
- **用户增长:** 网络依赖限制了弱网地区用户增长

---

## 3. 用户画像

### 3.1 主要用户

| 画像 | 描述 | 目标 | 痛点 |
|--------|------|------|--------|
| **游戏玩家** | 玩日文/韩文游戏的 Android 用户,需要翻译剧情和 UI | 实时理解游戏剧情和选项 | 云端翻译太慢错过剧情;文本框拆分读起来累 |
| **漫画读者** | 阅读日文/韩文漫画的用户,需要快速翻译对话 | 高效阅读,不打断心流 | 等待时间长破坏沉浸感;横竖排识别错乱 |
| **多语言工作者** | 需要翻译外语文档、菜单、界面的职场人士 | 快速理解外语文档内容 | 网络不稳定时无法工作;隐私担忧 |
| **旅行者** | 出国旅游需要翻译标识、菜单的游客 | 即时翻译周围环境 | 无漫游数据时无法使用;流量消耗大 |

---

## 4. 用户故事

### 4.1 核心功能

#### [US-001] 本地 OCR 识别
**作为** 游戏玩家,我想要 **在设备上识别日文、韩文、英文文本**,以便 **在没有网络的情况下也能翻译游戏对话**

**验收标准:**
- OCR 全程在本地运行,无需网络请求
- 识别速度 <400ms (中端机) 或 <200ms (旗舰机)
- 支持日文、韩文、英文三种主要语言
- 返回文字 + 像素坐标
- 使用 Google ML Kit Text Recognition v2 API

#### [US-002] 智能文本合并
**作为** 漫画读者,我想要 **自动合并同一行的多个文本框**,以便 **翻译后文本完整可读**

**验收标准:**
- Y 轴聚类将相邻行识别为一组
- X 轴合并同行文本 (间隙自适应)
- 横竖排自动检测并分别处理
- 合并后文本保持段落结构 (用 "\n" 分行)

#### [US-003] 本地翻译
**作为** 旅行者,我想要 **离线翻译识别出的文本**,以便 **在海外漫游时节省流量**

**验收标准:**
- 翻译全程在本地,无需网络
- 支持中英日韩互译
- 翻译速度 <200ms/段
- 语言包首次下载后可离线使用

#### [US-004] 覆盖层显示
**作为** 游戏玩家,我想要 **翻译文本显示在原位置**,以便 **快速理解而不切换应用**

**验收标准:**
- 白色背景框 + 翻译文本
- 坐标对齐原文位置
- 支持流式逐条显示 (减少等待)
- 双击关闭覆盖层

#### [US-005] 性能模式切换
**作为** 多语言工作者,我想要 **选择速度优先或精度优先模式**,以便 **根据设备性能调整**

**验收标准:**
- 提供 "极速"、"平衡"、"高精" 三种模式
- 不同模式自动应用图片分辨率和模型复杂度
- 设置页显示当前模式和预估延迟

#### [US-006] 混合模式 (云端备选)
**作为** 漫画读者,我想要 **使用云端模型翻译专有名词**,以便 **提高角色名和术语准确度**

**验收标准:**
- 设置页提供 "本地/云端/混合" 选项
- 离线时自动切换到本地模式
- 云端模式使用纯文本模型 (7B/3B) 降低延迟
- API Key 安全存储在 Android Keystore

### 4.2 UI/UX 配置功能

#### [US-007] 实验室本地 OCR 开关
**作为** 用户,我想要 **在实验室中启用或禁用本地 OCR 功能**,以便 **根据我的需求选择使用云端 VLM 还是本地 OCR 方案**

**验收标准:**
- 实验室页面显示"本地 OCR"开关
- 开关默认关闭（使用云端 VLM 方案）
- 开启后主页面显示 Tab 切换和方案切换器
- 开关状态持久化存储

#### [US-008] 主页面方案切换器
**作为** 用户,我想要 **通过切换器在 VLM 云端和本地 OCR 方案间切换**,以便 **快速选择当前使用的翻译方案**

**验收标准:**
- 切换器位于 Tab 上方
- 关闭状态：使用 VLM 云端方案（默认）
- 开启状态：使用本地 OCR 方案
- 切换状态实时生效并持久化

#### [US-009] 主页面 Tab 切换
**作为** 用户,我想要 **在开启本地 OCR 后通过 Tab 查看不同配置页面**,以便 **分别配置 VLM 云端和本地 OCR 的参数**

**验收标准:**
- 仅在开启本地 OCR 后显示 Tab
- Tab 1: VLM 云端翻译（现有功能）
- Tab 2: 本地 OCR 配置
- Tab 位置在权限配置上方

#### [US-010] 本地 OCR 翻译模式选择
**作为** 用户,我想要 **选择本地 OCR 后的翻译方式**,以便 **根据场景选择本地 ML Kit 或云端 LLM 翻译**

**验收标准:**
- 提供两种翻译模式：本地 ML Kit / 云端 LLM
- 默认选择本地 ML Kit
- 选择云端 LLM 时显示额外配置项
- 选择状态持久化

#### [US-011] 云端 LLM 提示词编辑
**作为** 高级用户,我想要 **自定义云端 LLM 翻译的提示词**,以便 **获得更符合场景的翻译结果**

**验收标准:**
- 选择云端 LLM 翻译时显示提示词编辑框
- 支持多行文本编辑
- 提供重置按钮恢复默认提示词
- 提示词内容持久化存储

#### [US-012] 云端 LLM 模型选择
**作为** 用户,我想要 **选择云端 LLM 的模型**,以便 **根据需要选择不同能力的模型**

**验收标准:**
- 提供模型下拉选择器
- 显示可用模型列表
- 选择状态持久化

#### [US-013] 语言包自动预下载
**作为** 用户,我想要 **在首次使用时自动下载翻译语言包**,以便 **后续使用时无需等待下载**

**验收标准:**
- 应用启动时自动检查语言包状态
- 后台下载常用语言对（中英日韩 12 个）
- 显示下载进度（已下载/总数）
- 支持 Wi-Fi 环境提示
- 下载失败时自动重试

#### [US-014] 语言包下载管理
**作为** 用户,我想要 **查看和管理语言包下载状态**,以便 **了解下载进度和存储占用**

**验收标准:**
- 设置页显示语言包下载状态
- 显示每个语言对的大小和下载状态
- 提供手动下载/删除功能
- 显示总存储占用

### 4.3 次要功能

#### [US-101] 语言包管理 (已移除)
**作为** 用户,我想要 **查看和管理已打包的翻译语言包**,以便 **了解支持的语言**

**验收标准:**
- 显示已打包的语言列表 (中英日韩)
- 显示每个语言包的大小和版本
- 提供语言包详细信息 (模型版本、支持的语言对)
- 明确说明所有语言已预装,无需下载

**注意:** 此功能已移除,所有语言包已打包进 APK

#### [US-102] 合并阈值调整
**作为** 高级用户,我想要 **调整文本合并的敏感度**,以便 **适配不同内容类型**

**验收标准:**
- 提供 "Y 轴合并阈值" 和 "X 轴合并阈值" 滑块
- 实时预览合并效果
- 预设方案 (游戏/漫画/文档/自定义)
- 显示当前合并的文本框数量 (合并前/后对比)

#### [US-103] 流式翻译显示
**作为** 游戏玩家,我想要 **逐步显示翻译结果**,以便 **减少等待焦虑**

**验收标准:**
- 翻译完成一条立即显示一条
- 覆盖层支持动态添加 (addResult)
- 显示进度指示器 (正在翻译: 3/10)
- 整体完成时震动提示

---

## 5. 功能需求

### 5.1 必须具备 (Must Have)

| ID | 需求 | 优先级 |
|----|--------|--------|
| **FR-001** | 系统应支持在设备上执行 OCR 文字识别,使用 Google ML Kit Text Recognition v2 API | P0 |
| **FR-002** | 系统应支持在设备上翻译文本,使用 Google ML Kit Translation API | P0 |
| **FR-003** | 系统应实现文本框合并算法,按 Y 轴聚类和 X 轴合并相邻框 | P0 |
| **FR-004** | 系统应检测横竖排文本方向并分别处理 | P0 |
| **FR-005** | 系统应在原位置绘制翻译覆盖层,使用归一化坐标转换为屏幕像素 | P0 |
| **FR-006** | 系统应支持日文、韩文、英文三种语言的 OCR 和翻译 | P0 |
| **FR-007** | 系统应完全离线工作,无需网络连接 (本地模式) | P0 |
| **FR-008** | 系统应支持通过悬浮窗截图触发翻译流程 | P0 |
| **FR-009** | 系统应处理 MediaProjection 权限请求和过期重新授权 | P0 |
| **FR-010** | 系统应将 OCR 结果转换为归一化 0-1 坐标存储,便于跨分辨率适配 | P0 |

### 5.2 UI/UX 功能需求 (Should Have)

| ID | 需求 | 优先级 |
|----|--------|--------|
| **FR-201** | 系统应在实验室页面提供"本地 OCR"开关,控制本地 OCR 功能的启用 | P0 |
| **FR-202** | 系统应在开启本地 OCR 后显示主页面 Tab 切换（权限配置上方） | P0 |
| **FR-203** | 系统应提供方案切换器,允许用户在 VLM 云端和本地 OCR 方案间切换 | P0 |
| **FR-204** | 系统应在本地 OCR Tab 中提供翻译模式选择（本地 ML Kit / 云端 LLM） | P0 |
| **FR-205** | 系统应支持云端 LLM 翻译的自定义提示词编辑和持久化 | P1 |
| **FR-206** | 系统应提供云端 LLM 模型选择器,支持多个模型选项 | P1 |
| **FR-207** | 系统应提供提示词重置功能,恢复默认提示词 | P1 |

### 5.3 语言包管理功能需求 (Should Have)

| ID | 需求 | 优先级 |
|----|--------|--------|
| **FR-301** | 系统应在应用启动时检查翻译语言包状态 | P0 |
| **FR-302** | 系统应自动下载常用语言对（中英日韩 12 个语言对） | P0 |
| **FR-303** | 系统应显示语言包下载进度（已下载/总数，百分比） | P0 |
| **FR-304** | 系统应在非 Wi-Fi 环境时提示用户确认是否下载 | P1 |
| **FR-305** | 系统应支持后台下载，退出应用后继续下载 | P1 |
| **FR-306** | 系统应提供语言包管理界面，显示状态和存储占用 | P1 |
| **FR-307** | 系统应支持手动删除已下载的语言包 | P2 |
| **FR-308** | 系统应在下载失败时自动重试（最多 3 次） | P1 |

### 5.4 性能优化功能需求 (Should Have)

| ID | 需求 | 优先级 |
|----|--------|--------|
| **FR-401** | 系统应支持批量翻译，每批最多 3 个文本并发处理 | P0 |
| **FR-402** | 本地 ML Kit 翻译应使用协程并发处理（3 个并发） | P0 |
| **FR-403** | 云端 LLM 翻译应使用协程并发处理（3 个并发） | P0 |
| **FR-404** | 系统应按批次顺序处理，完成一批再处理下一批 | P0 |
| **FR-405** | 批量翻译应显示整体进度（已完成批次/总批次） | P1 |

### 5.5 API Key 与校验规则 (Should Have)

| ID | 需求 | 优先级 |
|----|--------|--------|
| **FR-501** | API Key 配置应放在实验室页面中 | P0 |
| **FR-502** | 默认翻译方案应为本地 OCR + 本地 ML Kit 翻译 | P0 |
| **FR-503** | 打开悬浮窗仅校验权限，不校验 API Key 或语言包 | P0 |
| **FR-504** | 使用本地翻译时，应引导用户下载语言包 | P1 |
| **FR-505** | 使用 VLM 或云端翻译方案时，应引导配置 API Key | P1 |
| **FR-506** | 翻译执行时应校验当前方案的依赖（语言包或 API Key） | P0 |

### 5.6 应该具备 (Should Have)

| ID | 需求 | 优先级 |
|----|--------|--------|
| **FR-101** | 系统应支持云端翻译 API 作为备选 (硅基流动 Qwen2.5-7B) | P1 |
| **FR-102** | 系统应提供性能模式切换 (极速/平衡/高精),自动调整图片分辨率 | P1 |
| **FR-103** | 系统应支持流式翻译,逐条显示结果减少感知延迟 | P1 |
| **FR-104** | 系统应支持下载和管理 Google ML Kit 翻译语言包 | P1 |
| **FR-105** | 系统应提供合并阈值可调设置 (Y 轴和 X 轴) | P1 |
| **FR-107** | 系统应安全存储云端 API Key (使用 Android Keystore) | P1 |
| **FR-108** | 系统应在本地模式失败时自动降级到云端 API (如果已配置) | P1 |

### 5.4 可以具备 (Could Have)

| ID | 需求 | 优先级 |
|----|--------|--------|
| **FR-201** | 系统应支持更多翻译语言 (超出中英日韩),使用其他本地模型 | P2 |
| **FR-202** | 系统应支持 NPU 加速推理 (Snapdragon Hexagon) | P2 |
| **FR-203** | 系统应提供 OCR 历史记录和翻译缓存 | P2 |
| **FR-204** | 系统应支持批量翻译 (相册多图) | P2 |
| **FR-205** | 系统应支持自定义翻译 Prompt (云端模式) | P2 |

---

## 6. 非功能需求

### 6.1 性能

| 指标 | 目标值 | 测量方式 |
|--------|---------|-----------|
| **OCR 延迟 (旗舰机)** | <200ms/张 | OnePlus 15 等设备实测 |
| **OCR 延迟 (中端机)** | <400ms/张 | Snapdragon 6/7 系列设备实测 |
| **翻译延迟 (本地)** | <100ms/段 | Google ML Kit 推理耗时 |
| **翻译延迟 (云端)** | <2s/次 | 硅基流动 API 端到端耗时 |
| **端到端延迟 (本地模式)** | <1s | 截图 → OCR → 合并 → 翻译 → 显示 |
| **端到端延迟 (云端模式)** | <5s | 截图 → OCR → 合并 → 翻译 → 显示 |
| **内存占用 (峰值)** | <400MB | Android Profiler 实测 |
| **APK 体积** | <50MB | Google ML Kit 内置,无额外模型文件 |

### 6.2 安全

| 需求 | 说明 |
|--------|------|
| **权限最小化** | 仅请求必需权限 (截图、悬浮窗、存储),无需网络权限 (本地模式) |
| **数据隐私** | 截图数据不上传服务器,仅本地处理,不持久化存储 |
| **API Key 保护** | 云端 API Key 使用 Android Keystore 加密存储 |
| **代码混淆** | 发布版本使用 R8/ProGuard 混淆代码 |
| **官方 SDK** | 使用 Google 官方 ML Kit SDK,无第三方模型文件 |

### 6.3 可扩展性

| 需求 | 说明 |
|--------|------|
| **模型扩展** | 支持通过插件机制添加新的 OCR/翻译模型 |
| **语言扩展** | 支持动态下载新语言包,无需更新 APK |
| **配置扩展** | 支持导入/导出配置,便于多设备同步 |
| **降级策略** | 本地失败自动切换云端,云端失败自动切换本地 |

### 6.4 兼容性

| 平台 | 版本支持 |
|--------|----------|
| **Android 最低版本** | API 24 (Android 7.0 Nougat) |
| **Android 目标版本** | API 36 (Android 14) |
| **架构支持** | arm64-v8a (主流旗舰)、armeabi-v7a (老设备) |
| **屏幕尺寸** | 任意分辨率,坐标归一化适配 |
| **存储空间** | 最低 500MB 可用空间 (安装 + 语言包) |

### 6.5 可维护性

| 需求 | 说明 |
|--------|------|
| **代码模块化** | OCR/翻译/合并/UI 组件解耦,便于独立测试和替换 |
| **日志系统** | 使用 Timber 分级日志 (DEBUG/INFO/WARN/ERROR),生产环境关闭 DEBUG |
| **崩溃监控** | 集成 Firebase Crashlytics 或 Sentry,自动收集崩溃堆栈 |
| **配置版本管理** | 模型版本、语言包版本独立管理,支持增量更新 |
| **单元测试覆盖** | 核心算法 (合并、坐标转换) 测试覆盖率 >80% |

---

## 7. 用户界面需求

### 7.1 设计原则

- **极简设计:** 主功能一键触发,减少操作步骤
- **实时反馈:** 加载状态、进度提示、错误信息清晰可见
- **可配置性:** 高级设置隐藏在二级菜单,避免普通用户困惑
- **无障碍支持:** 覆盖层文本支持 TalkBack,颜色对比度符合 WCAG AA

### 7.2 关键界面

| 界面 | 描述 | 关键元素 |
|--------|------|----------|
| **悬浮球** | 常驻屏幕的浮动入口 | 拖拽、双击、长按关闭,状态动画 (空闲/加载/成功/错误) |
| **翻译覆盖层** | 在原位置显示翻译结果的透明视图 | 白色背景框、翻译文本、自适应字号、双击关闭 |
| **设置主页** | 模式、语言、性能配置入口 | OCR 模式选择、源/目标语言、性能模式、关于 |
| **实验室页面** | 实验性功能开关 | 本地 OCR 开关、流式翻译开关、文本合并开关 |
| **主页面（本地 OCR 开启后）** | 方案切换和 Tab 导航 | 方案切换器、VLM 云端 Tab、本地 OCR Tab |
| **本地 OCR Tab** | 本地 OCR 配置页面 | 翻译模式选择、云端 LLM 配置（提示词、模型选择） |
| **VLM 云端 Tab** | 云端 VLM 配置页面 | API Key 配置、模型选择、提示词编辑 |
| **语言包下载页** | 翻译语言包下载管理 | 下载进度、语言对列表、状态指示、存储占用 |
| **语言包管理** | 下载和删除翻译语言 | 语言列表、下载进度、存储占用、删除按钮 |
| **高级设置** | 合并阈值、分辨率限制、流式开关 | Y 轴阈值滑块、X 轴阈值滑块、预设方案选择 |
| **权限引导** | MediaProjection 和悬浮窗权限请求 | 步骤说明、跳转系统设置按钮 |

### 7.3 主页面布局（本地 OCR 开启后）

```
┌─────────────────────────────────────────────┐
│              应用标题栏                      │
├─────────────────────────────────────────────┤
│  ┌─────────────────────────────────────┐    │
│  │   方案切换器                         │    │
│  │   [VLM云端] ━━━●━━━━ [本地OCR]       │    │
│  └─────────────────────────────────────┘    │
├─────────────────────────────────────────────┤
│  ┌────────────────┬────────────────┐        │
│  │   VLM云端 Tab  │   本地OCR Tab  │        │
│  └────────────────┴────────────────┘        │
├─────────────────────────────────────────────┤
│                                             │
│            Tab 内容区域                      │
│                                             │
│   （VLM Tab: API Key、模型、提示词）         │
│   （本地 OCR Tab: 翻译模式、LLM 配置）       │
│                                             │
├─────────────────────────────────────────────┤
│                                             │
│            权限配置区域                      │
│                                             │
├─────────────────────────────────────────────┤
│              底部导航                        │
└─────────────────────────────────────────────┘
```

### 7.4 本地 OCR Tab 详细设计

```
┌─────────────────────────────────────────────┐
│  翻译模式                                    │
│  ┌─────────────────────────────────────┐    │
│  │  ◉ 本地 ML Kit 翻译                 │    │
│  │  ○ 云端 LLM 翻译                    │    │
│  └─────────────────────────────────────┘    │
│                                             │
│  ┌─────────────────────────────────────┐    │
│  │  云端 LLM 配置（选择云端 LLM 时显示） │    │
│  ├─────────────────────────────────────┤    │
│  │  模型选择                            │    │
│  │  [Qwen2.5-7B-Instruct ▼]            │    │
│  │                                     │    │
│  │  翻译提示词                          │    │
│  │  ┌─────────────────────────────┐    │    │
│  │  │ 请将以下文本翻译成中文：      │    │    │
│  │  │ {text}                       │    │    │
│  │  │                              │    │    │
│  │  │                              │    │    │
│  │  └─────────────────────────────┘    │    │
│  │                                     │    │
│  │  [重置为默认提示词]                  │    │
│  └─────────────────────────────────────┘    │
│                                             │
│  ┌─────────────────────────────────────┐    │
│  │  合并阈值设置                        │    │
│  │  Y轴容差: [=====●=====] 0.4         │    │
│  │  X轴容差: [===●=======] 1.5         │    │
│  └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘
```

### 7.5 无障碍

| 需求 | 说明 |
|--------|------|
| **触控目标大小** | 最小可点击区域 48×48dp (Android 指南) |
| **内容描述** | 覆盖层文本提供 `contentDescription` 属性 |
| **颜色对比度** | 白色背景框与翻译文本对比度 ≥4.5:1 (WCAG AA) |
| **键盘导航** | 设置页支持 Tab 键导航和 Enter 确认 |

---

## 8. 数据与隐私

### 8.1 数据收集

| 数据类型 | 用途 | 保留期限 |
|-----------|---------|----------|
| **截图 Bitmap** | OCR 和翻译 | 处理后立即释放,不持久化 |
| **OCR 文本** | 翻译和覆盖层显示 | 会话期间内存保留,应用关闭后删除 |
| **翻译结果** | 覆盖层显示 | 会话期间内存保留,应用关闭后删除 |
| **配置数据** | 用户偏好设置 | 持久化存储,直到用户卸载应用或清除数据 |
| **崩溃日志** | 问题诊断和改进 | 保留 30 天 (Firebase/Sentry 策略) |

### 8.2 隐私需求

| 需求 | 说明 |
|--------|------|
| **零数据上传** | 截图、OCR 文本、翻译结果均不上传服务器 |
| **本地处理** | 所有 AI 推理在设备完成,无需网络 |
| **用户控制** | 用户可选择启用云端 API,但默认关闭 |
| **透明度** | 隐私政策明确说明数据处理方式 |
| **合规性** | 符合 GDPR (欧盟)、CCPA (加州) 等隐私法规 |

---

## 9. 成功度量

### 9.1 关键绩效指标 (KPI)

| 指标 | 目标值 | 时间线 |
|--------|---------|--------|
| **端到端延迟 (P50)** | <1s (本地模式) | 1.0 版本发布后 30 天 |
| **端到端延迟 (P95)** | <1.5s (本地模式) | 1.0 版本发布后 30 天 |
| **离线可用率** | >95% (仅限本地模式) | 持续监控 |
| **翻译准确率** | >85% (人工评测 100 样本) | 1.0 版本发布后 60 天 |
| **用户留存 (D7)** | >40% (安装后 7 日仍活跃) | 1.0 版本发布后 90 天 |
| **崩溃率** | <0.5% (用户会话) | 持续监控 |
| **应用评分** | ≥4.0/5.0 (Google Play) | 1.0 版本发布后 90 天 |

### 9.2 完成定义 (Definition of Done)

- [ ] Google ML Kit Text Recognition v2 本地 OCR 功能实现并通过单元测试
- [ ] Google ML Kit 本地翻译集成,支持中英日韩
- [ ] 文本合并算法实现 (Y 聚类 + X 合并 + 横竖检测)
- [ ] 覆盖层绘制支持归一化坐标和自适应字号
- [ ] 悬浮窗截图流程完整 (权限 → 截图 → OCR → 翻译 → 显示)
- [ ] 性能模式切换功能 (极速/平衡/高精)
- [ ] 本地模式端到端延迟 <1s (OnePlus 15 实测)
- [ ] 云端 API 备选模式集成 (硅基流动)
- [ ] 语言包管理 UI 和下载逻辑
- [ ] 通过 UI 自动测试和手动探索性测试
- [ ] 发布到 Google Play Beta 渠道
- [ ] 收集 100 个用户反馈并迭代优化
- [ ] 稳定版本发布到 Production 渠道

---

## 9.3 UI/UX 功能实现状态 (2026-02-13 更新)

| 用户故事 | 需求ID | 状态 | 说明 |
|---------|--------|------|------|
| [US-007] 实验室本地 OCR 开关 | FR-201 | ✅ 完成 | LabSettingsScreen 已添加开关 |
| [US-008] 主页面方案切换器 | FR-203 | ✅ 完成 | SchemeSwitcher 组件已创建 |
| [US-009] 主页面 Tab 切换 | FR-202 | ✅ 完成 | Tab 导航已添加 |
| [US-010] 本地 OCR 翻译模式选择 | FR-204 | ⚠️ 组件已创建，未集成 | TranslationModeSelector 已创建，但未在 LocalOcrTabContent 中使用 |
| [US-011] 云端 LLM 提示词编辑 | FR-205 | ⚠️ 组件已创建，未集成 | CloudLlmConfigEditor 已创建，但未在 LocalOcrTabContent 中使用 |
| [US-012] 云端 LLM 模型选择 | FR-206 | ⚠️ 组件已创建，未集成 | CloudLlmConfigEditor 已创建，但未在 LocalOcrTabContent 中使用 |
| [US-013] 语言包自动预下载 | FR-301-303 | ✅ 完成 | LanguagePackManager 已实现 |
| [US-014] 语言包下载管理 | FR-306 | ⚠️ 页面已创建，无导航入口 | LanguagePackManagementScreen 已创建，但无入口跳转 |

**待修复问题:**

| 问题ID | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| FIX-001 | LocalOcrTabContent 仅显示"开发中"占位符，需集成实际组件 | P0 | 待修复 |
| FIX-002 | 语言包管理页面无导航入口 | P0 | 待修复 |
| FIX-003 | 实验室页面返回键直接退出应用 | P1 | 待修复 |

**详细修复计划见:** `doc-arch/ocr-local-deployment/99_Value_Details.md`

---

## 10. 假设与约束

### 10.1 假设

| 假设 | 说明 |
|--------|------|
| **设备性能** | 目标用户拥有中端及以上 Android 设备 (Snapdragon 660+ 或等效) |
| **存储空间** | 用户设备至少有 200MB 可用空间 |
| **网络质量** | 下载翻译语言包时有 Wi-Fi 或稳定移动网络 (仅首次) |
| **技术可行性** | Google ML Kit Text Recognition v2 和 Translation API 在 Android 上可稳定运行 |
| **用户意愿** | 用户愿意首次使用时下载翻译语言包 (约 30-60MB/语言对) |

### 10.2 约束

| 约束 | 说明 |
|--------|------|
| **APK 体积** | <50MB | Google ML Kit 内置,仅含翻译语言包 |
| **内存限制** | 单次加载 Bitmap + 翻译不超过 400MB |
| **功耗预算** | 后台服务和悬浮窗需控制唤醒频率,避免耗电过快 |
| **权限复杂性** | MediaProjection 权限需用户手动授予,无法自动获取 |
| **语言限制** | Google ML Kit Text Recognition v2 支持 70+ 语言,本阶段专注日韩英 |
| **API 免费额度** | 硅基流动等云服务有免费额度限制,超限后需付费 |

---

## 11. 风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|--------|--------|--------|----------|
| **Google ML Kit OCR 精度不足** | 识别准确度下降 | 中 | 对比测试多种 OCR 方案,提供云端 API 备选 |
| **Google ML Kit 翻译质量不足** | 用户满意度下降 | 中 | 提供云端 API 备选,专有名词使用大模型翻译 |
| **文本合并算法不准确** | 翻译结果可读性差 | 中 | 提供可调阈值,收集用户反馈优化默认值 |
| **语言包下载失败率高** | 用户无法使用翻译 | 中 | 实现断点续传和重试机制,提供手动下载入口 |
| **MediaProjection 权限过期** | 用户需要重复授权 | 高 | 自动检测过期并引导重新授权,保存上次权限状态 |
| **竞品已有离线方案** | 市场竞争力下降 | 高 | 强调 "智能合并" 和 "横竖检测" 等差异化功能 |
| **云端 API 成本过高** | 开发者盈利困难 | 中 | 本地模式优先,云端仅作为高质量备选 |

---

## 12. 开放问题

- [Q1] Google ML Kit Text Recognition v2 对游戏专有名词 (技能名、装备) 识别准确度如何?
- [Q2] Google ML Kit 对游戏专有名词 (技能名、装备) 翻译准确度如何,是否需要后处理?
- [Q3] 文本合并阈值的最佳默认值是多少 (日文 vs 韩文 vs 英文)?
- [Q4] 是否应该支持云端 VL 模型的流式响应,以进一步降低延迟?
- [Q5] 覆盖层文本自适应字号算法:如何处理超长文本在小框内的显示?
- [Q6] 混合模式 (本地+云端) 的切换逻辑:手动选择 vs 自动降级 vs 智能预测?
- [Q7] 是否需要提供 OCR 历史记录和翻译缓存,或会增加隐私风险?
- [Q8] Google ML Kit Text Recognition v2 在横排/竖排混合场景下的表现如何?

---

## 附录

### A. 术语表

| 术语 | 定义 |
|--------|------|
| **OCR (Optical Character Recognition)** | 光学字符识别,从图像中提取文字 |
| **VL (Vision-Language) Model** | 视觉语言模型,同时处理图像和文本的多模态 AI |
| **Google ML Kit** | Google 提供的机器学习 SDK,包含本地 OCR 和翻译 API |
| **归一化坐标** | 0-1 或 0-1000 范围的相对坐标,与屏幕尺寸无关 |
| **文本框合并** | 将 OCR 输出的多个相邻小框合并为逻辑行的算法 |
| **横竖排检测** | 识别文本是横向排列 (从左到右) 还是竖向排列 (从上到下) |
| **MediaProjection** | Android 系统 API,允许应用捕获屏幕内容 |
| **Snapdragon 8 Elite Gen 5** | 高通 2025 年旗舰 SoC,含强大 CPU/GPU/NPU |
| **流式翻译** | 增量返回翻译结果,逐条显示而非等待全部完成 |

### B. 参考资料

- [Google ML Kit Text Recognition 文档](https://developers.google.com/ml-kit/vision/text-recognition/v2/android)
- [Google ML Kit Translation 文档](https://developers.google.com/ml-kit/translation)
- [硅基流动 API 文档](https://docs.siliconflow.cn/)
- [Android MediaProjection 指南](https://developer.android.com/guide/topics/media/projection)
- [OnePlus 15 技术规格](https://www.oneplus.com/15/specs)
- [Qwen2.5-VL 模型卡片](https://huggingface.co/Qwen/Qwen2.5-VL-32B-Instruct)

---

**文档状态:** 待评审
**下一步:** 创建系统架构设计文档
